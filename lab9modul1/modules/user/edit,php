<?php
// modules/data_barang/edit.php (Mengubah data)

function is_select($val, $var) {
    if ($var == $val) return 'selected="selected"';
    return '';
}

function redirect_list() {
    header('location: index.php?page=data_barang/list'); 
    exit;
}

// 1. Logika Pemrosesan Form UPDATE saat di-submit
if (isset($_POST['submit']))
{
    // ... (Logika pengambilan data form dan upload gambar) ...
    $id = mysqli_real_escape_string($conn, $_POST['id']);
    $nama = mysqli_real_escape_string($conn, $_POST['nama']);
    $kategori = mysqli_real_escape_string($conn, $_POST['kategori']);
    $harga_jual = mysqli_real_escape_string($conn, $_POST['harga_jual']);
    $harga_beli = mysqli_real_escape_string($conn, $_POST['harga_beli']);
    $stok = mysqli_real_escape_string($conn, $_POST['stok']);
    $file_gambar = $_FILES['file_gambar'];
    $gambar  = null;

    // Proses upload gambar baru (jika ada)
    if ($file_gambar ['error'] == 0)
    {
        $filename  = str_replace(' ', '_', $file_gambar['name']);
        $destination = dirname(dirname(dirname(__FILE__))) . '/assets/gambar/' . $filename;

        if (move_uploaded_file($file_gambar['tmp_name'], $destination))
        {
            $gambar = $filename; 
        }
    }
    
    // Query UPDATE
    $sql = 'UPDATE data_barang SET ';
    $sql.= "nama = '{$nama}', kategori = '{$kategori}', ";
    $sql.= "harga_jual = '{$harga_jual}', harga_beli = '{$harga_beli}', stok = '{$stok}' ";
    
    if (!empty($gambar)) 
    {
        $sql.=", gambar = '{$gambar}' ";
    }
    
    $sql.= "WHERE id_barang = '{$id}'"; 
    
    $result  = mysqli_query($conn, $sql);
    
    if ($result) {
        redirect_list();
    } else {
        echo "Gagal memperbarui data: " . mysqli_error($conn);
    }
}

// 2. Logika Pengambilan Data untuk ditampilkan di form
if (!isset($_GET['id'])) {
    redirect_list();
}
$id = mysqli_real_escape_string($conn, $_GET['id']);
$sql = "SELECT * FROM data_barang WHERE id_barang = '{$id}'";
$result  = mysqli_query($conn, $sql);

if (!$result || mysqli_num_rows($result) == 0) {
    die('Error: Data tidak ditemukan.');
}
$data  = mysqli_fetch_array($result);

?>
<h1 style="text-align: center;">Ubah Barang</h1>
<form method="post" action="index.php?page=data_barang/edit" enctype="multipart/form-data">
    <div class="input">
        <label>Nama Barang</label>
        <input type="text" name="nama" value="<?php echo htmlspecialchars($data['nama']);?>" required/>
    </div>
    <div class="input">
        <label>Kategori</label>
        <select name="kategori" required>
            <option <?php echo is_select($data['kategori'], 'Komputer'); ?> value="Komputer">Komputer</option>
            <option <?php echo is_select($data['kategori'], 'Elektronik');?> value="Elektronik">Elektronik</option>
            <option <?php echo is_select($data['kategori'], 'Hand Phone'); ?> value="Hand Phone">Hand Phone</option>
        </select>
    </div>
    <div class="input">
        <label>Harga Jual</label>
        <input type="number" name="harga_jual" value="<?php echo htmlspecialchars($data['harga_jual']);?>" required/>
    </div>
    <div class="input">
        <label>Harga Beli</label>
        <input type="number" name="harga_beli" value="<?php echo htmlspecialchars($data['harga_beli']);?>" required/>
    </div>
    <div class="input">
        <label>Stok</label>
        <input type="number" name="stok" value="<?php echo htmlspecialchars($data['stok']);?>" required/>
    </div>
    <div class="input">
        <label>File Gambar (Kosongkan jika tidak diubah)</label>
        <input type="file" name="file_gambar" />
        <?php if ($data['gambar']): ?>
            <p>Gambar Saat Ini: 
                <img src="assets/gambar/<?php echo htmlspecialchars($data['gambar']);?>" style="max-width: 100px; max-height: 100px; display: block; margin-top: 10px;">
            </p>
        <?php endif; ?>
    </div>
    <div class="submit">
        <input type="hidden" name="id" value="<?php echo htmlspecialchars($data['id_barang']);?>" />
        <input type="submit" name="submit" value="Simpan Perubahan" />
    </div>
</form>